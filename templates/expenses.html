<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceHub - Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='expenses.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h2>FinanceHub</h2>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/trade" class="nav-link">Trading</a>
            <a href="/expenses" class="nav-link active">Expenses</a>
            <a href="/learn" class="nav-link">AI Advisor</a>
            <a href="/profile" class="nav-link">Profile</a>
            <a href="/logout" class="nav-link logout">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="expenses-header">
            <h1>Expense Tracker</h1>
            <button class="add-expense-btn" onclick="toggleExpenseForm()">+ Add Expense</button>
        </div>

        <div class="expense-form-container" id="expenseFormContainer" style="display: none;">
            <div class="expense-form">
                <h3>Add New Expense</h3>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amount">Amount (â‚¹)</label>
                            <input type="number" id="amount" name="amount" step="0.01" min="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="Food">Food</option>
                                <option value="Transport">Transport</option>
                                <option value="Subscriptions">Subscriptions</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Trading fees">Trading fees</option>
                                <option value="Miscellaneous">Miscellaneous</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description</label>
                            <input type="text" id="description" name="description" placeholder="Optional notes">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Add Expense</button>
                        <button type="button" class="cancel-btn" onclick="toggleExpenseForm()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="expenses-content">
            <div class="expenses-analytics">
                <div class="chart-container">
                    <h3>Weekly Expenses</h3>
                    <canvas id="weeklyChart" width="400" height="200"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Category Breakdown</h3>
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>
            </div>

            <div class="expenses-list">
                <h3>Recent Expenses</h3>
                <div class="expense-filters">
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="Food">Food</option>
                        <option value="Transport">Transport</option>
                        <option value="Subscriptions">Subscriptions</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Trading fees">Trading fees</option>
                        <option value="Miscellaneous">Miscellaneous</option>
                    </select>
                </div>
                
                <div id="expensesList" class="expenses-items">
                    <div class="loading">Loading expenses...</div>
                </div>
            </div>

            <div class="savings-insights">
                <h3>ðŸ’¡ Savings Insights</h3>
                <div id="savingsInsights" class="insights-list">
                    <div class="insight-item">
                        <span class="insight-icon">ðŸ“Š</span>
                        <p>Add expenses to get personalized savings insights</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let expenses = [];
        let weeklyChart, categoryChart;

        // Toggle expense form
        function toggleExpenseForm() {
            const container = document.getElementById('expenseFormContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            
            if (container.style.display === 'block') {
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }
        }

        // Load expenses
        async function loadExpenses() {
            try {
                const response = await fetch('/api/expenses');
                expenses = await response.json();
                displayExpenses();
                updateCharts();
                generateInsights();
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        // Display expenses
        function displayExpenses() {
            const expensesList = document.getElementById('expensesList');
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            const filteredExpenses = categoryFilter 
                ? expenses.filter(expense => expense.category === categoryFilter)
                : expenses;

            if (filteredExpenses.length === 0) {
                expensesList.innerHTML = '<p class="no-expenses">No expenses found</p>';
                return;
            }

            expensesList.innerHTML = filteredExpenses.map(expense => `
                <div class="expense-item">
                    <div class="expense-info">
                        <span class="expense-category">${expense.category}</span>
                        <span class="expense-description">${expense.description || 'No description'}</span>
                        <span class="expense-date">${new Date(expense.date).toLocaleDateString()}</span>
                    </div>
                    <div class="expense-amount">â‚¹${expense.amount}</div>
                </div>
            `).join('');
        }

        // Update charts
        function updateCharts() {
            updateWeeklyChart();
            updateCategoryChart();
        }

        // Update weekly chart
        function updateWeeklyChart() {
            const weeklyData = {};
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                if (expenseDate >= oneWeekAgo) {
                    const day = expenseDate.toLocaleDateString('en-US', { weekday: 'short' });
                    weeklyData[day] = (weeklyData[day] || 0) + parseFloat(expense.amount);
                }
            });

            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            if (weeklyChart) {
                weeklyChart.destroy();
            }

            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(weeklyData),
                    datasets: [{
                        label: 'Daily Expenses',
                        data: Object.values(weeklyData),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update category chart
        function updateCategoryChart() {
            const categoryData = {};
            
            expenses.forEach(expense => {
                categoryData[expense.category] = (categoryData[expense.category] || 0) + parseFloat(expense.amount);
            });

            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Generate savings insights
        function generateInsights() {
            const insightsContainer = document.getElementById('savingsInsights');
            
            if (expenses.length === 0) {
                return;
            }

            const insights = [];
            const categoryTotals = {};
            const thisWeekTotal = calculateWeeklyTotal();
            const lastWeekTotal = calculateLastWeekTotal();

            // Calculate category totals
            expenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + parseFloat(expense.amount);
            });

            // Find highest spending category
            const highestCategory = Object.keys(categoryTotals).reduce((a, b) => 
                categoryTotals[a] > categoryTotals[b] ? a : b
            );

            insights.push({
                icon: 'ðŸ“Š',
                text: `Your highest spending category is ${highestCategory} (â‚¹${categoryTotals[highestCategory].toFixed(2)})`
            });

            // Week comparison
            if (lastWeekTotal > 0) {
                const change = ((thisWeekTotal - lastWeekTotal) / lastWeekTotal * 100).toFixed(1);
                const changeText = change > 0 ? `${change}% more` : `${Math.abs(change)}% less`;
                insights.push({
                    icon: change > 0 ? 'âš ï¸' : 'âœ…',
                    text: `You spent ${changeText} this week compared to last week`
                });
            }

            // Savings suggestion
            const totalSpending = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
            const suggestedSavings = (totalSpending * 0.2).toFixed(2);
            insights.push({
                icon: 'ðŸ’°',
                text: `Try to save â‚¹${suggestedSavings} by reducing discretionary spending`
            });

            insightsContainer.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <span class="insight-icon">${insight.icon}</span>
                    <p>${insight.text}</p>
                </div>
            `).join('');
        }

        // Calculate weekly totals
        function calculateWeeklyTotal() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            return expenses
                .filter(expense => new Date(expense.date) >= oneWeekAgo)
                .reduce((total, expense) => total + parseFloat(expense.amount), 0);
        }

        function calculateLastWeekTotal() {
            const twoWeeksAgo = new Date();
            twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            return expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= twoWeeksAgo && expenseDate < oneWeekAgo;
                })
                .reduce((total, expense) => total + parseFloat(expense.amount), 0);
        }

        // Handle expense form submission
        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const expenseData = {
                amount: formData.get('amount'),
                category: formData.get('category'),
                date: formData.get('date'),
                description: formData.get('description')
            };

            try {
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(expenseData)
                });

                if (response.ok) {
                    alert('Expense added successfully!');
                    e.target.reset();
                    toggleExpenseForm();
                    loadExpenses();
                } else {
                    alert('Error adding expense. Please try again.');
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                alert('Error adding expense. Please try again.');
            }
        });

        // Category filter change
        document.getElementById('categoryFilter').addEventListener('change', displayExpenses);

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadExpenses();
        });
    </script>
</body>
</html>